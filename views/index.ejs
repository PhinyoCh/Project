<%- include('./sidebar.ejs')  -%> 

    <main class="mt-5 pt-3 ">
      <div class="container-fluid">
          <div class="row">
            <div class="card">
              <div class="card-header bg-dark">
                <h3 class="text-uppercase text-center text-white mt-4">sound control</h3>
              </div>

              <div class="card-body">
                <div class="table-responsive">
                  <table id="table-room-id" class="table display" style="width: 100%">
                    <thead>                     
                      <tr>
                        <th class="text-center">NUMBER</th>
                        <th class="text-center">ROOM NUMBER</th>
                        <th class="text-center">ROOM NAME</th>
                        <th class="text-center">FLOOR</th>
                        <th class="text-center">STATUS</th>
                        <th class="text-center">ACTION</th>
                        <th class="text-center">OPERACTION</th>
                      </tr>
                    </thead>
                    <tbody>
                      <div class="text-end" mx-3>
                        <!-- <button class=" btn btn-success" id="allon-switch">All On</button>
                        <button class=" btn btn-danger" id="alloff-switch">All Off</button> -->
                        <% if (role == 'Admin') { %> 
                        <button type="submit" data-bs-toggle="modal" data-bs-target="#add-modal" class="btn btn-primary"><i class="bi bi-plus-square"></i>ADD</button> 
                        <% } %> 
                      </div>
                    </tbody> 
                  </table>
                </div>
              </div>
            </div>
          </div>
      </div>

      <!-- Modal ADD Button -->
      <div class="modal fade" id="add-modal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="exampleModalLabel">Add Room</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="addroom-form" class="needs-validation" novalidate>
              <div class="modal-body">
                <div class="form">
                  <div class="row">
                    <div class="col-md-12 mb-3">
                      <label for="room-name" class="form-label"> Room Name </label>
                      <input type="text" class="form-control" id="input-addroomname" required >
                      <div class="invalid-feedback">
                        Please Enter Room Name.
                      </div>
                    </div>
                  </div>
                  <div class="row">
                    <div class="col-md-6 mb-3">
                      <label for="room-number" class="form-label"> Room Number </label>
                      <input type="text" class="form-control" id="input-addroomnumber" required>
                      <div class="invalid-feedback">
                        Please Enter Room Number.
                      </div>
                    </div>
                    <div class="col-md-6 mb-3">
                      <label for="room-name" class="form-label"> Floor </label>
                      <select class="form-select" style="margin-top: 7px;margin-bottom: 7px;padding-top: 9px;padding-bottom: 9px;" id="input-addfloor" required>
                        <option selected disabled value="">Select Floor...</option>
                        <option value="1">1</option>
                        <option value="2">2</option>
                        <option value="3">3</option>
                      </select>
                      <div class="invalid-feedback">
                        Please select a floor.
                      </div>
                    </div>
                  </div>
                  <div class="row">
                    <div class="col-md-12 mb-3">
                      <label for="room-macaddress" class="form-label"> Mac Address </label>
                      <input type="text" class="form-control" id="input-addmacaddress" required>
                      <div class="invalid-feedback">
                        Please Enter Mac Address.
                      </div>
                    </div>
                  </div>
                </div>
              </div>  
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="submit-addroom" class="btn btn-primary">Submit</button>
              </div>
            </form>
          </div>
        </div>
      </div>

      <!-- Modal Edit Button -->
      <div class="modal fade" id="edit-modal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="exampleModalLabel">Edit Room</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="edit-form" class="needs-validation" novalidate>
              <div class="modal-body">
                <div class="form">
                  <div class="row">
                    <div class="col-md-12 mb-3">
                      <label for="room-name" class="form-label"> Room Name </label>
                      <input type="text" class="form-control" id="input-editroomname" required >
                      <div class="invalid-feedback">
                        Please Enter Room Name.
                      </div>
                    </div>
                  </div>
                  <div class="row">
                    <div class="col-md-6 mb-3">
                      <label for="room-number" class="form-label"> Room Number </label>
                      <input type="text" class="form-control" id="input-editroomnumber" required>
                      <div class="invalid-feedback">
                        Please Enter Room Number.
                      </div>
                    </div>
                    <div class="col-md-6 mb-3">
                      <label for="room-name" class="form-label"> Floor </label>
                      <select class="form-select" style="margin-top: 7px;margin-bottom: 7px;padding-top: 9px;padding-bottom: 9px;" id="input-editfloor" required>
                        <option selected disabled value="">Select Floor...</option>
                        <option value="1">1</option>
                        <option value="2">2</option>
                        <option value="3">3</option>
                      </select>
                      <div class="invalid-feedback">
                        Please select a floor.
                      </div>
                    </div>
                  </div>
                  <div class="row">
                    <div class="col-md-12 mb-3">
                      <label for="room-macaddress" class="form-label"> Mac Address </label>
                      <input type="text" class="form-control" id="input-editmacaddress" required disabled>
                      <div class="invalid-feedback">
                        Please Enter Mac Address.
                      </div>
                    </div>
                  </div>
                </div>
              </div>  
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button id="submit-edit" type="submit-edit" class="btn btn-primary">Submit</button>
              </div>
            </form>
          </div>
        </div>
      </div>

      <!-- Modal Mode File -->
      <div class="modal fade" id="modefile-modal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="exampleModalLabel">Mode Select File</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="mode-form" class="needs-validation" novalidate>
              <div class="modal-body">
                <div class="form">
                  <div class="row">
                    <div class="col-md-6 mb-3">
                      <label for="file-name" class="form-label"> File Name </label>
                      <select class="form-select" style="margin-top: 7px;margin-bottom: 7px;padding-top: 9px;padding-bottom: 9px;" id="file-name" required>
                        <option selected disabled value="">Select Filename...</option>
                      </select>
                      <div class="invalid-feedback">
                        Please Select a Filename.
                      </div>
                    </div>
                    <div class="col-md-12 mb-1">
                      <label for="select-room" class="form-label">Select Room</label>
                      <select data-placeholder="Begin typing a name to filter..." multiple class="chosen-select" name="test">
                        <option value=""></option>
                        <option>American Black Bear</option>
                        <option>Asiatic Black Bear</option>
                        <option>Brown Bear</option>
                        <option>Giant Panda</option>
                        <option>Sloth Bear</option>
                        <option>Sun Bear</option>
                        <option>Polar Bear</option>
                        <option>Spectacled Bear</option>
                      </select>
                      <div class="invalid-feedback">
                        Please Enter Password.
                      </div>
                    </div>                    
                  </div>              
                </div>                                   
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="submit-addroom" class="btn btn-primary">Submit</button>
              </div>
            </form>
          </div>
        </div>
      </div>

      <br>
      <div class="container col-md-2 border-center">
        <select class="form-select" id="dropdown-mode">
          <option selected disabled value="">Mode Play Sound</option>
          <option value="1">MP3 File</option>
          <option value="2">LIVE Streaming</option>
        </select>
        <button type="submit" name="select-mode" onclick="onClickMode()" style="border-top-width: 1px;margin-top: 10px;margin-left: 50px;" class="btn btn-secondary">SELECT</button>
      </div> 
    </main>
  </body>
</html>




<script src="/public/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.0.2/dist/chart.min.js"></script>
<script src="/public/js/script.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script type="text/javascript" language="javascript" src="https://code.jquery.com/jquery-3.5.1.js"></script>
<script type="text/javascript" language="javascript" src="https://cdn.datatables.net/1.10.21/js/jquery.dataTables.min.js"></script>
<script type="text/javascript" language="javascript" src="https://cdn.datatables.net/select/1.3.1/js/dataTables.select.min.js"></script>
<link href="//cdn.jsdelivr.net/npm/@sweetalert2/theme-dark@4/dark.css" rel="stylesheet">
<script src="//cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.js"></script>
<link rel="stylesheet" href="/node_modules/@sweetalert2/themes/dark/dark.css">
<script src="/node_modules/sweetalert2//dist/sweetalert2.min.js"></script>

<script src="https://cdn.rawgit.com/harvesthq/chosen/gh-pages/chosen.jquery.min.js"></script>
<link href="https://cdn.rawgit.com/harvesthq/chosen/gh-pages/chosen.min.css" rel="stylesheet"/>

<script>

  
  function onClickMode(){
    let mode = $("#dropdown-mode").val();
    if (mode == 1){
      $('#modefile-modal').modal('toggle');
    } else if (mode == 2){
      Swal.fire({
        icon: 'info',
        title: 'Sorry',
        text: 'This mode is under development.',
      })
    } else {
      Swal.fire({
        icon: 'warning',
        text: 'You did not select the mode Please select a mode.',
      })
    }

  }

  var Feature = (function(){
      let glo_room_id;
      let glo_role = '<%=role %>';
      let glo_state;
      var dataTable = $('#table-room-id').DataTable({
        language : {emptyTable: "ไม่พบข้อมูล"},
        ordering: false,
        searching: false,
        lengthChange: false,
        paging: false,
        bAutoWidth: false,
        info: false,
        columns: [
          { 
            data: function (data) {
              return data['room_id'];                  // ข้อมูล ' ลำดับ '
            },
            className : 'text-center',              // จัดให้ข้อมูลอยู่ตรงกลาง
          },
          { 
            data: function (data) {
              return data['room_number'];                  // ข้อมูล ' เลขห้อง '
            },
            className : 'text-center',              // จัดให้ข้อมูลอยู่ตรงกลาง
          },
          { 
            data: function (data) {
              return data['room_name'];                  // ข้อมูล ' ชื่อห้อง '
            },
            className : 'text-center',              // จัดให้ข้อมูลอยู่ตรงกลาง
          },
          { 
            data: function (data) {
              return data['floor'];                  // ข้อมูล ' ชั้น '
            },
            className : 'text-center',              // จัดให้ข้อมูลอยู่ตรงกลาง
          },
          { 
            data: function (data) {
              var status = ""
              if(data['status'] == 0){
                status = '<span class="btn btn-danger">Failure</span>';
              } else {
                status = '<span class="btn btn-success">Active</span>'
              }
              return status;                  // ข้อมูล ' สเตตัส Node '
            },
            className : 'text-center',              // จัดให้ข้อมูลอยู่ตรงกลาง
          },
          { 
            data: function (data) {
              return '<div class="form-switch" id="swform">\
                     <input class="form-check-input" name="switch" type="checkbox" value="'+data['room_id'] +'" id="switch-'+data['room_id'] +'">\
                     <span class="switch-label" data-on="Yes" data-off="No"></span>\
                     <span class="switch-handle"></span>\
                    </div>';               
            },
            className : 'text-center align-middle',              // จัดให้ข้อมูลอยู่ตรงกลาง
          },
          { 
            data: function (data) {
              return '<button type="submit" data-bs-toggle="modal" data-bs-target="#edit-modal" name="edit-room" class="btn btn-primary"\
                data-id="' + data['room_id'] + '" data-room_name="' + data['room_name'] + '" data-room_number="' + data['room_number'] + '"\
                data-mac_address="' + data['mac_address'] + '" data-ip_address="' + data['ip_address'] + '" data-floor="' + data['floor'] + '" \
                data-status="' + data['status'] + '"><i class="fa fa-edit"></i>Edit</button>\
                <button type="submit" name="delete_room" class="btn btn-danger" data-id="' + data['room_id'] + '"><i class="fa fa-trash"></i>Delete</button>';
            },
            className : 'text-center',              // จัดให้ข้อมูลอยู่ตรงกลาง
          }
        ],
        serverSide: true,   // เปิดการรับ - ส่งข้อมูลของตาราง
        ajaxSource: '/Search',   // path สำหรับการรับ - ส่งข้อมูล (service)
        serverData: function(sSource, aaData, fnCallback, oSettings) { // สร้าง function สำหรับการรับ - ส่งข้อมูล
            //aaData.push({ "name": "search", "value": aaSearch});     // กำหนดข้อมูลที่จะค้นหา
            oSettings.jqXHR = $.ajax({  // รับ - ส่งข้อมูลโดยใช้ ajax
                dataType: 'json',       // กำหนดรูปแบบข้อมูลเป็น json
                type: "POST",           // กำหนดประเภทการส่งแบบ POST
                url: sSource,           // path สำหรับการรับ - ส่งข้อมูล (ajaxSource)
                data: aaData,           // ข้อมูลที่ส่ง 
                success: function (response) {  // ถ้าติดต่อสำเร็จ
                   if(response === undefined){
                    response = {"aaData":[], "iTotalRecords": 0, "iTotalDisplayRecords": 0};    // จัดเรียงข้อมูลที่ได้รับใหม่ --> -->

                   }else{
                    response = {"aaData": response, "iTotalRecords": response.length, "iTotalDisplayRecords": response.length}; // จัดเรียงข้อมูลที่ได้รับใหม่
                     
                   }

                    fnCallback(response);   // นำข้อมูลกลับขึ้นไป loop ใน columns
                }
            });
        }
      })
      return {

        initialButton : function(){
          $.ajax({ 
            url: '/upload/searchRecord',
            type: 'POST',
            dataType: 'JSON',
            success: function(res){
              $.each(res, function(index, data){
                $('#file-name').append('<option value="'+data['sound_address']+'">'+data['record_name']+'</option>')
              })
            }
           })
        },

        onClickSentFile: function(){
          'use strict'
          // Fetch all the forms we want to apply custom Bootstrap validation styles to
          var forms = document.querySelectorAll('#mode-form.needs-validation')     
          // Loop over them and prevent submission
          Array.prototype.slice.call(forms)
            .forEach(function (form) {
              form.addEventListener('submit', function (event) {
                if (!form.checkValidity()) {
                  event.preventDefault();
                  event.stopPropagation();
                } else {
                  event.preventDefault();
                  let dateNow = Feature.getDateNow();
                  //let room_name = $('#input-editroomname').val();              
                  let filename = $('#file-name').val();          
                  
                  $.ajax({ 
                    url: '/socket',
                    data: {
                      "filename":filename,
                    },
                    type: 'POST',
                    success: function(response)
                    {
                      /*
                      if(response.status == 'error self remove'){
                        Swal.fire(
                        'error',
                        'Sorry...',
                        'You cannot edit this room!'
                      )
                      } 
                      else if (response.status == 'successes'){
                        Swal.fire(
                        'Succeed!',
                        'Room Edit Succeeded.',
                        'success'
                      ).then(function(){
                        $('#edit-modal').modal('toggle');
                        dataTable.ajax.reload();
                      });                        
                      }*/
                    }
                  });
                }      
                form.classList.add('was-validated')
                
              }, false)
            })
        }, 

        getDateNow: function(){
          /* Update Date*/
          const now = new Date();                                                                     //
          const offsetMs = now.getTimezoneOffset() * 60 * 1000;                                       //
          const dateLocal = new Date(now.getTime() - offsetMs);                                       //  >> รับค่าวันที่และเวลา ปัจจุบัน
          const str = dateLocal.toISOString().slice(0, 19).replace(/-/g, "/").replace("T", " ");      //
              dateNow = str; 
            /**************/
          return dateNow;
        },

        // ฟังก์ชั่น เมื่อ กดปุ่ม Submit Add
        onSubmitAddRoom:  function(){
          'use strict'
          // Fetch all the forms we want to apply custom Bootstrap validation styles to
          var forms = document.querySelectorAll('#addroom-form.needs-validation')     
          // Loop over them and prevent submission
          Array.prototype.slice.call(forms)
            .forEach(function (form) {
              form.addEventListener('submit', function (event) {
                if (!form.checkValidity()) {
                  event.preventDefault();
                  event.stopPropagation();
                }else{
                  event.preventDefault();
                  // ประกาศตัวแปรเวลาปัจจุบัน
                  let dateNow = Feature.getDateNow();
                  // รับค่าจากฟอร์ม
                  let room_name = $('#input-addroomname').val();         
                  let room_number = $('#input-addroomnumber').val();   
                  let floor = $('#input-addfloor').val();
                  let mac_address = $('#input-addmacaddress').val();  
                  $.ajax({ 
                    url: '/PostAddRoom',
                    data: {
                      "room_name":room_name,
                      "room_number":room_number,
                      "floor":floor,
                      "mac_address":mac_address,
                      "status":0,
                      "active":1,
                      "update_date":dateNow,
                      "create_date":dateNow,
                    },
                    type: 'post',
                    success: function(response)
                    { 
                      if(response.status == 'Failed'){
                        Swal.fire({
                          icon: 'error',
                          title: 'Sorry...',
                          text: "Can't add this room."}).then(function(){
                            let room_name = $('#input-addroomname').val('');              
                            let room_number = $('#input-addroomnumber').val('');     
                            let floor = $('#input-addfloor').val('');
                            let mac_address = $('#input-addmacaddress').val('');
                            $('#add-modal').modal('toggle');
                            dataTable.ajax.reload();
                        });
                      } 
                      else if (response.status == 'successes'){
                        Swal.fire(
                          'Succeed!',
                          'Room has been added successfully.',
                          'success').then(function(){
                          $('#add-modal').modal('toggle');
                          dataTable.ajax.reload();
                        });
                      }
                    }
                  });
                  }
                form.classList.add('was-validated')
                
              }, false)
            })
        },

        // ฟังก์ชั่น กดปุ่ม Edit
        onClickEditBtn : function (){
            $('#table-room-id').on('click', '[name="edit-room"]', function () {  // ปุ่ม 'แก้ไข' ของข้อมูลข้อมูลห้อง
            var data = $(this).data();  // รับข้อมูลจากปุ่มแก้ไข ที่กดในแถวตารางข้อมูล
            glo_room_id = data.id;
            // set value นำข้อมูล response จาก ID มาใส่ในฟอร์
            $('#input-editroomname').val(data.room_name);              
            $('#input-editroomnumber').val(data.room_number);    
            $('#input-editfloor').val( data.floor);      
            $('#input-editmacaddress').val(data.mac_address);  
          });
        },


        // ฟังก์ชั่น เมื่อ กดปุ่ม Submit Edit
        onSubmitEditRoom : function(){
          'use strict'
          // Fetch all the forms we want to apply custom Bootstrap validation styles to
          var forms = document.querySelectorAll('#edit-form.needs-validation')     
          // Loop over them and prevent submission
          Array.prototype.slice.call(forms)
            .forEach(function (form) {
              form.addEventListener('submit', function (event) {
                if (!form.checkValidity()) {
                  event.preventDefault();
                  event.stopPropagation();
                } else {
                  event.preventDefault();
                  let dateNow = Feature.getDateNow();
                  let room_name = $('#input-editroomname').val();              
                  let room_number = $('#input-editroomnumber').val();    
                  let floor = $('#input-editfloor').val();      
                  
                  $.ajax({ 
                    url: '/PostEditRoom',
                    data: {
                      "room_id":glo_room_id,
                      "room_name":room_name,
                      "room_number":room_number,
                      "floor":floor,
                      "update_date":dateNow,
                    },
                    type: 'post',
                    success: function(response)
                    {
                      if(response.status == 'error self remove'){
                        Swal.fire(
                        'error',
                        'Sorry...',
                        'You cannot edit this room!'
                      )
                      } 
                      else if (response.status == 'successes'){
                        Swal.fire(
                        'Succeed!',
                        'Room Edit Succeeded.',
                        'success'
                      ).then(function(){
                        $('#edit-modal').modal('toggle');
                        dataTable.ajax.reload();
                      });                        
                      }
                    }
                  });
                }      
                form.classList.add('was-validated')
                
              }, false)
            })
        }, 

        // ปุ่มเลือกห้อง
        selectionRoom : function(){
        
          $('.form-check-input').on('change', function() {
            var isChecked = $(this).is(':checked');
            var selectedData;
            var $switchLabel = $('.switch-label');
            console.log('isChecked: ' + isChecked); 
            
            if(isChecked) {
              selectedData = $switchLabel.attr('data-on');
            } else {
              selectedData = $switchLabel.attr('data-off');
            }
            
            console.log('Selected data: ' + selectedData);
            
          });

        },
        
        // ฟังก์ชั่น กดปุ่ม Remove Room
        onClickRemoveBtn : function () {
          $('#table-room-id').on('click', '[name="delete_room"]', function () {    // ปุ่ม 'ลบ' ของข้อมูลห้องในแถวตารางข้อมูล
            var data = $(this).data();
            glo_room_id = data.id; 
            Swal.fire({
              title: 'Are you sure?',
              text: "Do you want to delete this Room ?",
              icon: 'warning',
              showCancelButton: true,
              confirmButtonColor: '#3085d6',
              cancelButtonColor: '#d33',
              confirmButtonText: 'Yes, delete it!'
            }).then((result) => {
              if(result.isConfirmed){
                $.ajax({ 
                  url: '/PostRemoveRoom',
                  data: {
                    "room_id": glo_room_id,
                    "update_date":Feature.getDateNow(),
                  },
                  type: 'post',
                  success: function(response)
                  {
                    if(response.status == 'error self remove'){
                      Swal.fire(
                        'error',
                        'Sorry...',
                        'You cannot delete this room!'
                      )
                    } 
                    else if (response.status == 'successes'){
                      Swal.fire(
                        'Succeed!',
                        'Room Deletion Succeeded.',
                        'success'
                      ).then(function(){
                        dataTable.ajax.reload();
                      });                          
                    }
                  }
                });
              }         
            })                  
          });
        },


        // ฟังก์ชั่น เมื่อ กดปุ่ม Submit Remove

      }
  })();

  jQuery(document).ready(function(){
      Feature.onClickEditBtn();
      Feature.onSubmitEditRoom();
      Feature.onClickRemoveBtn();
      Feature.onSubmitAddRoom();
      Feature.selectionRoom();
      Feature.initialButton();
      Feature.onClickSentFile();
  });

</script>

